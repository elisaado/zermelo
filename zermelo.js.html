<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>zermelo.js - Documentation</title>

    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Announcement.html">Announcement</a></li><li><a href="Appointment.html">Appointment</a></li><li><a href="module-zermelo-Zermelo.html">Zermelo</a><ul class='methods'><li data-type='method'><a href="module-zermelo-Zermelo.html#_url">_url</a></li><li data-type='method'><a href="module-zermelo-Zermelo.html#announcements">announcements</a></li><li data-type='method'><a href="module-zermelo-Zermelo.html#appointments">appointments</a></li><li data-type='method'><a href="module-zermelo-Zermelo.html#school">school</a></li><li data-type='method'><a href="module-zermelo-Zermelo.html#userInfo">userInfo</a></li></ul></li><li><a href="School.html">School</a></li><li><a href="SessionInfo.html">SessionInfo</a></li><li><a href="User.html">User</a></li></ul><h3>Modules</h3><ul><li><a href="module-zermelo.html">zermelo</a><ul class='members'><li data-type='member'><a href="module-zermelo.html#.VERSION">VERSION</a></li></ul><ul class='methods'><li data-type='method'><a href="module-zermelo.html#~createSession">createSession</a></li><li data-type='method'><a href="module-zermelo.html#~loginBySessionInfo">loginBySessionInfo</a></li></ul></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">zermelo.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @module zermelo
 */

import fetch from 'node-fetch'
import FormData from 'form-data'
import _ from 'lodash'
import Announcement from './announcement.js'
import Appointment from './appointment.js'
import School from './school.js'
import SessionInfo from './sessionInfo.js'
import User from './user.js'
import * as util from './util.js'

/**
 * @private
 */
class Zermelo {
	/**
	 * @param {String} apiUrl
	 * @param {SessionInfo} sessionInfo
	 */
	constructor(apiUrl, sessionInfo) {
		/**
		 * @type String
		 * @readonly
		 * @private
		 */
		this._apiUrl = apiUrl
		/**
		 * @type SessionInfo
		 * @readonly
		 */
		this.sessionInfo = sessionInfo
	}

	/**
	 * Builds an url with `this._apiUrl` and the current's session accessToken,
	 * while adding `slug`.
	 * @private
	 * @param {String} slug
	 * @return {String}
	 */
	_url(slug) {
		const c = /\?/.test(slug) ? '&amp;' : '?'
		return `${this._apiUrl}/${slug}${c}access_token=${this.sessionInfo.accessToken}`
	}

	/**
	 * @param {Object} [options={}]
	 * 	@param {Boolean} [options.current=true]
	 * 	@param {Date} [options.from] Time is ignored.
	 * 	@param {Date} [options.to] Time is ignored.
	 * @return {Promise&lt;Announcement[]>}
	 */
	announcements({ current = true, from, to } = {}) {
		let slug = ''
		if (from != null &amp;&amp; to != null) {
			if (!util.isValidDate(from) || !util.isValidDate(to)) {
				return Promise.reject(new Error('from and to must be valid dates'))
			}

			from = util.date(from)
			to = util.date(to)

			slug += `&amp;start=${util.urlDate(from)}&amp;end=${util.urlDate(to)}`
		} else if (current) {
			slug += '&amp;current=true'
		}

		const url = this._url(`announcements?user=~me${slug}`)
		return fetch(url)
		.then(util.mustBeOk)
		.then(res => res.json())
		.then(res => res.response.data)
		.then(items => items.map(a => new Announcement(a)))
		.then(items => _.sortBy(items, 'start'))
	}

	/**
	 * @param {Date} from
	 * @param {Date} [to=from + 1 day]
	 * @param {Object} [options={}]
	 * 	@param {Boolean} [options.onlyBase=false] If `true` only base
	 * 	apopointments are given.
	 * 	@param {Boolean} [options.latest] If `true` only the latest appointments
	 * 	are given, if `false` only the non-latest appointments are given, and
	 * 	when `undefined` this option is ignored.
	 * 	@param {Boolean} [options.cancelled] If `true` only cancelled
	 * 	appointments are given, if `false` only non-cancelled appointments are
	 * 	given, and when `undefined` this option is ignored.
	 * 	@param {Boolean} [options.includeHidden=false] Whether or not to include
	 * 	hidden appointments.
	 * 	@param {Date} [options.modifiedSince] When this is not `undefined`,
	 * 	`options.latest` will be set to undefined.
	 * 	@param {Boolean} [options.ignoreTime=true] If `true` the time is set to
	 * 	00:00 for both `from` and `to`.
	 * @return {Promise&lt;Appointment[]>}
	 */
	appointments() {
		let [ from, to ] = _(arguments).filter(_.isDate).sortBy().value()
		if (to == null) {
			to = new Date(from)
			to.setDate(to.getDate() + 1)
		}

		if (!util.isValidDate(from) || !util.isValidDate(to)) {
			return Promise.reject(new Error('from and to must be valid dates'))
		}

		const options = _.find(arguments, _.isPlainObject) || {}
		let {
			onlyBase = false,
			latest,
			cancelled,
			includeHidden = false,
			modifiedSince,
			ignoreTime = true,
		} = options

		if (ignoreTime) {
			from = util.date(from)
			to = util.date(to)
		}

		let url = `appointments?user=~me&amp;start=${util.urlDate(from)}&amp;end=${util.urlDate(to)}`

		if (modifiedSince != null) {
			url += `&amp;modifiedSince=${util.urlDate(modifiedSince)}`
			latest = false
		}

		if (onlyBase != null) {
			url += `&amp;base=${onlyBase}`
		}
		if (latest != null) {
			url += `&amp;valid=${latest}`
		}
		if (cancelled != null) {
			url += `&amp;cancelled=${cancelled}`
		}
		if (includeHidden != null) {
			url += `&amp;includeHidden=${includeHidden}`
		}

		return fetch(this._url(url))
		.then(util.mustBeOk)
		.then(res => res.json())
		.then(res => res.response.data)
		.then(items => items.map(i => new Appointment(i)))
		.then(items => _.sortBy(items, 'start'))
	}

	/**
	 * @return {Promise&lt;User>}
	 */
	userInfo() {
		return fetch(this._url('users/~me'))
		.then(util.mustBeOk)
		.then(res => res.json())
		.then(res => res.response.data[0])
		.then(res => new User(res))
	}

	/**
	 * @return {Promise&lt;School>}
	 */
	school() {
		return fetch(this._url('schools'))
		.then(util.mustBeOk)
		.then(res => res.json())
		.then(res => res.response.data[0])
		.then(res => new School(res))
	}
}

function getApiUrl (schoolid) {
	return `https://${schoolid}.zportal.nl/api/v3`
}

/**
 * @method loginBySessionInfo
 * @param {String} schoolid
 * @param {SessionInfo} sessionInfo
 * @return {Zermelo}
 */
export function loginBySessionInfo (schoolid, sessionInfo) {
	const apiUrl = getApiUrl(schoolid)
	return new Zermelo(apiUrl, sessionInfo)
}

/**
 * @method createSession
 * @param {String} schoolid
 * @param {String} authcode
 * @return {Promise&lt;SessionInfo>}
 */
export function createSession (schoolid, authcode) {
	const apiUrl = getApiUrl(schoolid)
	const url = `${apiUrl}/oauth/token`
	authcode = authcode.replace(/[^0-9]/g, '')

	const form = new FormData()
	form.append('grant_type', 'authorization_code')
	form.append('code', authcode)

	return fetch(url, {
		method: 'POST',
		body: form,
	})
	.then(util.mustBeOk)
	.then(r => r.json())
	.then(r => new SessionInfo(r))
	.catch(() => {
		throw new Error('invalid authcode')
	})
}

/**
 * The version of the library.
 * @type String
 * @readonly
 */
export const VERSION = __VERSION__

export {
	Announcement,
	Appointment,
	School,
	SessionInfo,
	User,
	Zermelo,
}
</code></pre>
        </article>
    </section>




</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.1</a> on Wed Sep 14 2016 19:50:31 GMT+0200 (CEST) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/linenumber.js"></script>
</body>
</html>
